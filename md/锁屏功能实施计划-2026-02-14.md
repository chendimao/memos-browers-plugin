# 锁屏功能实施计划

> 实施方式：使用 `subagent-driven-development` 或同等的分任务执行流程，逐步完成并校验。

## 功能目标
- 在设置页新增“启用锁屏”设置。
- 开启锁屏时，要求输入“密码 + 确认密码”，并进行一致性校验后保存。
- 在页面 Header 新增锁图标，可执行锁定/解锁。
- 点击锁定前需要输入“密码 + 确认密码”进行验证；验证通过后进入锁定态。
- 锁定态显示覆盖层，仅展示解锁输入区域（密码 + 确认密码）与确认按钮。

## 技术方案
- 配置存储：在 `memos-settings` 中新增 `lockEnabled`、`lockPasswordHash` 字段。
- 密码处理：不保存明文，使用浏览器 `crypto.subtle` 做 SHA-256 哈希后存储/比对。
- UI 结构：
  - `setting.vue` 增加锁屏开关与密码输入项（仅在开启锁屏时显示）。
  - `App.vue` Header 增加锁图标；新增“锁定前验证弹层”和“锁定覆盖层解锁表单”。
- 交互约束：
  - 锁屏开启且未设置哈希时，不允许保存。
  - 锁定、解锁都要求两次输入一致，且与已保存哈希匹配。

## 任务步骤
1. 新增锁屏工具函数
- 新建 `src/utils/lock.ts`。
- 提供 `hashPassword(password)` 与 `verifyPassword(password, hash)`。
- 使用 `TextEncoder + crypto.subtle.digest` 输出十六进制哈希。

2. 补充设置项与默认值
- 修改 `src/App.vue` 的 `useStorage('memos-settings', ...)` 默认结构，加入 `lockEnabled`、`lockPasswordHash`。
- 修改 `src/views/setting.vue` 的 `resetSettings` 默认结构，加入同字段。

3. 设置页新增锁屏区块与保存校验
- 修改 `src/views/setting.vue` 模板：
  - 在“其他设置”或独立分组新增 `启用锁屏` 复选框。
  - 开启时显示 `密码`、`确认密码` 输入框（本地临时变量）。
- 修改 `saveSettings`：
  - 开启锁屏时校验两次密码非空且一致。
  - 对新密码执行哈希，写入 `settingsToSave.lockPasswordHash`。
  - 若已有哈希且本次未改密码，允许沿用旧哈希。

4. Header 加锁按钮与状态切换
- 修改 `src/App.vue` 模板 `header-actions`：
  - `settings.lockEnabled` 时显示锁图标按钮。
  - 根据 `isLocked` 切换 icon（`fa-lock-open` / `fa-lock`）与 title。
- 新增状态：`isLocked`、`showLockVerifyModal`、`lockAction`、`lockForm`。

5. 实现锁定前验证与锁定覆盖层
- 修改 `src/App.vue`：
  - 点击锁图标（未锁定）先弹“锁定前验证框”：密码 + 确认密码；校验一致并通过哈希比对后执行锁定。
  - 锁定后显示全屏（组件内）覆盖层，阻断编辑/列表交互。
  - 解锁在覆盖层内输入密码 + 确认密码，校验一致且匹配哈希后解除锁定。
  - 若关闭 `lockEnabled`，自动取消锁定态并关闭相关弹层。

6. 国际化文案补充
- 修改 `src/i18n/messages.js` 的 `zh/en`：新增锁屏分组文案（开关、密码、确认密码、锁定、解锁、校验错误提示等）。

7. 样式补充
- 修改 `src/App.vue`、`src/views/setting.vue` 样式：
  - 锁图标按钮样式。
  - 验证弹层与锁定遮罩层样式（兼容浅色/深色）。

8. 验证
- 构建验证：`npm run build`。
- 手动回归：
  - 设置页开启锁屏并保存成功。
  - 锁定前输入错误/不一致时拦截。
  - 锁定后页面交互不可用，仅可解锁。
  - 解锁成功恢复操作。
  - 关闭锁屏后锁图标隐藏并自动解除锁定态。

## 涉及文件
- 新增：`src/utils/lock.ts`
- 修改：`src/App.vue`
- 修改：`src/views/setting.vue`
- 修改：`src/i18n/messages.js`

## 风险与应对
- 风险1：浏览器环境 `crypto.subtle` 不可用。
  - 应对：加入可用性判断并给出错误提示。
- 风险2：锁定态遮罩影响现有布局高度计算。
  - 应对：遮罩采用绝对定位覆盖 `.memos-extension`，不改变原有容器高度逻辑。
- 风险3：设置页保存流程已有 API 校验，新增逻辑可能导致异常分支。
  - 应对：将锁屏校验放在 API 测试之前，失败即早返回。
